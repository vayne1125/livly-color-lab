# 🎨 Livly Color Lab: 演算法設計筆記 (Solver Architecture)

本文件紀錄了 **Livly Color Lab** 的演算法設計思路。
我們的目標是在瀏覽器端實現一個高效、精確的調色路徑搜尋器，協助玩家用最少的飼料達成目標顏色。

---

## 🚀 問題定義

Livly 的調色系統在數學上是一個 **3D 網格最短路徑問題 (Shortest Path Problem)**：
- **狀態空間**：RGB 三原色 (0-450 in livly), 約 $9 \times 10^7$ 個狀態。
- **操作向量**：8 種蟲子，每種蟲子對 RGB 有不同的增減效果（如：瓢蟲 `+4, -2, -2`）。
- **目標**：尋找從 $Start(R,G,B)$ 到 $Target(R,G,B)$ 的最短操作序列。

由於狀態空間龐大，單純的 BFS 或甚至標準 A* 在瀏覽器中可能會有效能瓶頸。

---

## 🧠 解決方案：混合式 A* (Hybrid A*)

我們採用了 **"Greedy Pre-pass (貪婪預處理) + A* Search"** 的混合架構。這套策略深受現有工具（特別是 [Hatena Blog](https://cinzanono.hatenablog.com/entry/2021/07/17/122549) 的作者）的啟發。我們觀察並學習了其優秀的規則庫邏輯，並嘗試將這些經驗法則融合進 A* 的啟發式搜尋中。

### 1. 智慧型貪婪預處理 (Context-Aware Greedy)

在進入高成本的 A* 搜尋前，我們先使用貪婪演算法快速消除大部分的顏色差距。
這裡我們參考了 Hatena 的策略，觀察到在 Livly 調色中，**「總質量 (Mass)」** 與 **「向量方向 (Vector)」** 同等重要。

*   **優先處理：向量對齊 (God Moves)**
    優先使用能同時滿足多個維度需求的蟲子（如瓢蟲），這能最有效率地修正方向。
    
*   **輔助策略：總量控制 (Mass Reduction)**
    當 RGB 總量與目標差異過大時，我們借鑒了 Hatena 的思路，採用「焦土策略」優先使用螞蟻 (`-2, -2, -2`) 進行快速減重，即使這可能會暫時犧牲單一顏色的準確度。實驗證明這對長路徑的搜尋至關重要。

### 2. A* 搜尋與啟發函數 (Heuristic)

當誤差縮小至一定範圍後，我們切換至 A* 演算法進行精密搜尋。為了讓 A* 能更好地處理「換色」過程，我們設計了一個包含 **質量懲罰 (Mass Penalty)** 的啟發函數：

$$ H(n) = H_{standard} + (MassDiff \times \epsilon) $$

這個微小的懲罰項引導 A* 在評估路徑時，會傾向選擇那些能保持總量平衡的走法。這不僅能找到數學上的最短路徑，也讓演算法在面對複雜案例時更具魯棒性。

---

## 🏆 模式說明：Fast vs Optimal

為了適應不同使用場景，我們提供了兩種計算模式：

| 模式 | 演算法 | 特點 | 適用情境 |
|------|--------|------|----------|
| **Fast (標準計算)** | **Weighted A* (w=1.02)** | 引入 2% 的貪婪權重。這會讓搜尋極快收斂，雖然不保證數學上的絕對最短（通常誤差 < 1%），但能提供秒開的體驗。 | 日常調色、快速預覽 |
| **Optimal (最佳計算)** | **Pure A* (w=1.0)** | 堅持使用 Admissible Heuristic。這保證了如果找到路徑，必然是數學上的最短路徑。我們會進行更深度的迭代搜尋，這需要較多時間。 | 追求極致省飼料、複雜長路徑 |

---

## 🛠 致謝與展望

本專案的演算法得以實現，很大程度上歸功於 Livly 社群前輩們的研究，特別感謝 Hatena Blog 的作者分享了許多關於運算邏輯的洞見。

Livly 調色問題本質上是一個 **具有邊界限制的大型狀態空間搜尋問題 (Large State Space Search with Boundary Constraints)**。雖然在理論上可解，但在瀏覽器資源受限的環境下，如何逼近即時回應 (Real-time Response) 仍是一大挑戰。

儘管目前的混合演算法已達到極高的準確率，但演算法領域永無止境。如果您是對圖論、啟發式搜尋有研究的同好，發現了更具優勢的啟發函數 (Heuristic Function) 或剪枝策略 (Pruning Strategy)，**非常歡迎您提供建議或發起討論**！讓我們一起為 Livly 玩家打造更好用的工具。

> *"Standing on the shoulders of giants."*
